<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mower_game</title>
    <style>
        :root {
            --bg-color: #222;
            --panel-bg: #333;
            --wc-gold: #FFD700;
            --wc-text: #eee;
            --accent-green: #2e7d32;
            --btn-gray: #b0bec5; /* N64 Controller Grey */
            --stick-gray: #eceff1;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--wc-text);
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        /* --- HUD (Top) --- */
        #top-bar {
            height: 40px;
            background-color: #000;
            border-bottom: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.8);
            z-index: 20;
        }
        .res-item {
            display: flex; align-items: center; gap: 8px;
            font-size: 14px; font-weight: bold; color: var(--wc-gold);
            text-shadow: 1px 1px 0 #333;
        }
        .res-alert { color: #ff3333; animation: flash 1s infinite; }
        @keyframes flash { 50% { opacity: 0.5; } }

        /* --- VIEWPORT --- */
        #viewport {
            flex: 1;
            background: #111;
            display: flex; justify-content: center; align-items: center;
            position: relative; overflow: hidden;
        }
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.8); image-rendering: pixelated; }

        /* --- CONTROLS --- */
        #controls-panel {
            height: 240px;
            background-color: var(--panel-bg);
            border-top: 4px solid #444;
            padding: 10px;
            display: flex;
            gap: 15px;
            box-sizing: border-box;
            align-items: center;
        }

        /* N64 JOYSTICK STYLE */
        .joystick-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .n64-gate {
            width: 140px; height: 140px;
            background: #444;
            border-radius: 50%;
            border: 4px solid #222;
            box-shadow: inset 0 0 15px #000;
            position: relative;
            /* Octagonal cut (visual only) */
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .joy-btn {
            z-index: 10;
            cursor: pointer;
            /* Debug: background: rgba(255,0,0,0.2); */
            background: transparent;
            border-radius: 50%;
            -webkit-tap-highlight-color: transparent;
        }
        .joy-btn:active { background: rgba(255,255,255,0.1); }

        /* The Stick Cap (Visual) */
        .stick-cap {
            position: absolute;
            top: 50%; left: 50%;
            width: 50px; height: 50px;
            background: radial-gradient(circle at 30% 30%, #fff, #999);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid #666;
            box-shadow: 0 5px 10px rgba(0,0,0,0.5);
            pointer-events: none; /* Let clicks pass through to grid */
            z-index: 5;
        }
        .stick-cap::after {
            content: ''; position: absolute; top: 10%; left: 10%;
            width: 80%; height: 80%;
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.1);
        }

        /* Center Console */
        .center-console {
            flex: 1.5;
            display: flex; flex-direction: column; gap: 10px; justify-content: center;
        }

        .slider-box {
            background: #222; padding: 8px; border-radius: 8px; border: 1px solid #444;
            display: flex; flex-direction: column; gap: 4px;
        }
        .slider-label { font-size: 10px; color: #888; text-transform: uppercase; }
        input[type=range] { width: 100%; accent-color: var(--wc-gold); cursor: pointer; }

        .action-row { display: flex; gap: 8px; }
        .action-btn {
            flex: 1; padding: 12px 5px; border: none; border-radius: 6px;
            color: white; font-weight: bold; font-family: inherit;
            cursor: pointer; text-transform: uppercase; font-size: 11px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.4);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-green { background: var(--accent-green); border: 1px solid #4caf50; }
        .btn-blue { background: #0277bd; border: 1px solid #29b6f6; }
        .btn-gold { background: #c79100; border: 1px solid #ffd700; color: #111; }
        .btn-alert { animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { filter: brightness(1); } to { filter: brightness(1.3); } }

        /* --- MENUS --- */
        #overlay-menu {
            display: none; position: absolute; top: 40px; left: 0; bottom: 0; right: 0;
            background: rgba(0,0,0,0.95); z-index: 50; padding: 20px; overflow-y: auto;
        }
        #overlay-menu.open { display: block; }
        .menu-header { color: var(--wc-gold); border-bottom: 1px solid #555; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .shop-item { background: #1a1a1a; border: 1px solid #333; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .shop-btn { background: var(--wc-gold); color: black; border: none; padding: 5px 15px; font-weight: bold; cursor: pointer; }
        
        .floater {
            position: absolute; color: var(--wc-gold); font-weight: bold; font-size: 18px;
            pointer-events: none; z-index: 100; text-shadow: 1px 1px 0 #000; animation: floatUp 1s forwards;
        }
        @keyframes floatUp { to { transform: translateY(-40px); opacity: 0; } }

    </style>
</head>
<body>

    <div id="top-bar">
        <div class="res-item"><span>ðŸ’°</span><span>Gold: <span class="res-val" id="hud-money">0</span></span></div>
        <div class="res-item" id="hud-fuel-box"><span>â›½</span><span>Fuel: <span class="res-val" id="hud-fuel">100%</span></span></div>
        <div class="res-item" id="hud-bag-box"><span>ðŸ“¦</span><span>Bag: <span class="res-val" id="hud-bag">0/20</span></span></div>
    </div>

    <div id="viewport">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="controls-panel">
        
        <!-- N64 Joystick -->
        <div class="joystick-area">
            <div class="n64-gate">
                <!-- 3x3 Grid of invisible buttons for 8-way directional control -->
                <!-- Row 1 -->
                <div class="joy-btn" onpointerdown="game.input(-1, -1)"></div> <!-- NW -->
                <div class="joy-btn" onpointerdown="game.input(0, -1)"></div>  <!-- N -->
                <div class="joy-btn" onpointerdown="game.input(1, -1)"></div>  <!-- NE -->
                
                <!-- Row 2 -->
                <div class="joy-btn" onpointerdown="game.input(-1, 0)"></div>  <!-- W -->
                <div class="joy-btn" style="pointer-events:none"></div>        <!-- Center (Deadzone) -->
                <div class="joy-btn" onpointerdown="game.input(1, 0)"></div>   <!-- E -->
                
                <!-- Row 3 -->
                <div class="joy-btn" onpointerdown="game.input(-1, 1)"></div>  <!-- SW -->
                <div class="joy-btn" onpointerdown="game.input(0, 1)"></div>   <!-- S -->
                <div class="joy-btn" onpointerdown="game.input(1, 1)"></div>   <!-- SE -->
                
                <!-- Visual Cap -->
                <div class="stick-cap"></div>
            </div>
        </div>

        <div class="center-console">
            <div class="slider-box">
                <div style="display:flex; justify-content:space-between;">
                    <span class="slider-label">Mower Speed</span>
                    <span class="slider-label" id="speed-label">5</span>
                </div>
                <input type="range" min="1" max="10" value="5" oninput="game.setThrottle(this.value)">
            </div>

            <div class="action-row">
                <button class="action-btn btn-green" id="btn-sell" onclick="game.sell()">
                    <span>Sell Bag</span>
                    <span style="font-size:10px; opacity:0.8" id="val-sell">$0</span>
                </button>
                <button class="action-btn btn-blue" id="btn-fuel" onclick="game.refuel()">
                    <span>Refuel</span>
                    <span style="font-size:10px; opacity:0.8">$5</span>
                </button>
                <button class="action-btn btn-gold" onclick="toggleMenu()">
                    <span>Maps</span>
                    <span>â‰¡</span>
                </button>
            </div>
        </div>
    </div>

    <div id="overlay-menu">
        <div class="menu-header">
            <h2 style="margin:0">MOWER_GAME</h2>
            <button class="shop-btn" style="background:#c62828; color:white;" onclick="toggleMenu()">CLOSE</button>
        </div>
        <div class="menu-section">
            <div style="color:#888; font-size:12px; margin-bottom:5px;">LOCATIONS</div>
            <div id="list-maps"></div>
        </div>
        <div class="menu-section">
            <div style="color:#888; font-size:12px; margin-bottom:5px;">UPGRADES</div>
            <div id="list-upgrades"></div>
        </div>
        <button class="action-btn btn-blue" style="width:100%" onclick="game.repair()">Repair Hull ($20)</button>
    </div>

    <script>
        const MAPS = [
            { id: 'yard', name: 'Backyard', w: 32, h: 18, rocks: 5, growth: 0.02, cost: 0, color: '#2d5a27' },
            { id: 'park', name: 'City Park', w: 48, h: 27, rocks: 30, growth: 0.05, cost: 500, color: '#1b5e20' },
            { id: 'golf', name: 'Golf Course', w: 64, h: 36, rocks: 70, growth: 0.08, cost: 5000, color: '#33691e' }
        ];

        const UPGRADES = [
            { id: 'drone', name: 'Auto-Drone', cost: 250, desc: 'Helper bot', type: 'drone' },
            { id: 'rider', name: 'Rider Hull', cost: 1000, desc: '300 Fuel / 100 Bag', type: 'hull', tank: 300, bag: 100 },
            { id: 'autosell', name: 'Auto-Link', cost: 2000, desc: 'Auto-sell clipping', type: 'tech' }
        ];

        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.viewport = document.getElementById('viewport');

                this.money = 0;
                this.map = MAPS[0];
                this.owned = ['yard'];
                this.drones = [];
                this.particles = [];

                this.mower = {
                    x: 0, y: 0, dx: 1, dy: 0,
                    fuel: 100, maxFuel: 100,
                    bag: 0, maxBag: 20,
                    health: 100,
                    throttle: 5,
                    moveTimer: 0,
                    state: 'MOWING'
                };

                this.grid = [];
                this.rocks = [];
                this.tileSize = 20;

                window.addEventListener('resize', () => this.resize());
                // Keyboard support for diagonals
                this.keys = {};
                window.addEventListener('keydown', (e) => { this.keys[e.key] = true; this.checkKeys(); });
                window.addEventListener('keyup', (e) => { this.keys[e.key] = false; });
            }

            checkKeys() {
                let dx = 0; let dy = 0;
                if(this.keys['ArrowUp']) dy = -1;
                if(this.keys['ArrowDown']) dy = 1;
                if(this.keys['ArrowLeft']) dx = -1;
                if(this.keys['ArrowRight']) dx = 1;
                if(dx !== 0 || dy !== 0) this.input(dx, dy);
            }

            init() {
                this.loadSave();
                this.loadMap(this.map.id, true);
                this.updateMenu();
                requestAnimationFrame(() => this.loop());
                setInterval(() => this.save(), 5000);
            }

            resize() {
                const vw = this.viewport.clientWidth;
                const vh = this.viewport.clientHeight;
                let targetW = vw;
                let targetH = vw * (9/16);
                if (targetH > vh) { targetH = vh; targetW = vh * (16/9); }
                this.canvas.width = targetW;
                this.canvas.height = targetH;
                this.tileSize = targetW / this.map.w;
                this.ctx.imageSmoothingEnabled = false;
            }

            setThrottle(val) {
                this.mower.throttle = parseInt(val);
                document.getElementById('speed-label').innerText = val;
            }

            getDelay() { return Math.max(2, 22 - (this.mower.throttle * 2)); }

            loadMap(id, force=false) {
                let m = MAPS.find(x => x.id === id);
                if(!m) return;
                if(!force && this.map.id === id) return;

                this.map = m;
                this.grid = [];
                this.rocks = [];

                for(let y=0; y<this.map.h; y++) {
                    let row = [];
                    for(let x=0; x<this.map.w; x++) row.push(2);
                    this.grid.push(row);
                }
                for(let i=0; i<this.map.rocks; i++) {
                    this.rocks.push({x: rand(0, this.map.w), y: rand(0, this.map.h)});
                }

                this.mower.x = 0; this.mower.y = 0;
                this.mower.dx = 1; this.mower.dy = 0;
                this.resize();
                toggleMenu(false);
            }

            input(x, y) {
                if(this.mower.state === 'NO_FUEL' || this.mower.state === 'BROKEN') return;
                this.mower.dx = x;
                this.mower.dy = y;
                // If bag is full, we stay MOWING but stop cutting in the cut() function
                // No more BAG_FULL state stopping movement
                this.mower.moveTimer = 100;
            }

            loop() {
                if(Math.random() < this.map.growth) {
                    let rx = rand(0, this.map.w); let ry = rand(0, this.map.h);
                    if(this.grid[ry][rx] < 2) this.grid[ry][rx]++;
                }

                if(this.owned.includes('autosell') && this.mower.bag >= this.mower.maxBag) this.sell();

                if(this.mower.health <= 0) this.mower.state = 'BROKEN';
                else if(this.mower.fuel <= 0) this.mower.state = 'NO_FUEL';
                else this.mower.state = 'MOWING'; // Always Mowing, even if bag full

                if(this.mower.state === 'MOWING') {
                    this.mower.moveTimer++;
                    if(this.mower.moveTimer >= this.getDelay()) {
                        this.mower.moveTimer = 0;
                        this.moveMower();
                    }
                }

                this.updateDrones();
                this.updateParticles();
                this.draw();
                this.updateUI();
                requestAnimationFrame(() => this.loop());
            }

            moveMower() {
                let nx = this.mower.x + this.mower.dx;
                let ny = this.mower.y + this.mower.dy;
                let hitWall = false;
                let hitRock = false;

                if (nx < 0 || nx >= this.map.w || ny < 0 || ny >= this.map.h) hitWall = true;
                
                if (!hitWall) {
                    for(let r of this.rocks) {
                        if (r.x === nx && r.y === ny) { hitRock = true; break; }
                    }
                }

                if (hitRock) {
                    this.mower.health -= (this.mower.throttle);
                    this.mower.dx *= -1; this.mower.dy *= -1;
                    this.spawnParticle(nx, ny, '#888');
                } 
                else if (hitWall) {
                    // Logic: If hitting wall, step over 1 in the OTHER axis, then reverse current axis
                    
                    // Case 1: Moving Horizontally (dx != 0, dy == 0)
                    if (this.mower.dy === 0) {
                        let nextY = this.mower.y + 1; // Default shift down
                        if (nextY >= this.map.h) nextY = this.mower.y - 1; // If at bottom, shift up
                        
                        // Check if shift is valid
                        if (nextY >= 0 && nextY < this.map.h) {
                            this.mower.y = nextY;
                            this.mower.dx *= -1; // Flip X
                            this.mower.fuel -= 0.1;
                            this.cut(this.mower.x, this.mower.y, true);
                        } else {
                            this.mower.dx *= -1; // Just bounce if trapped
                        }
                    } 
                    // Case 2: Moving Vertically (dy != 0, dx == 0)
                    else if (this.mower.dx === 0) {
                        let nextX = this.mower.x + 1; // Default shift right
                        if (nextX >= this.map.w) nextX = this.mower.x - 1; // If at right, shift left
                        
                        if (nextX >= 0 && nextX < this.map.w) {
                            this.mower.x = nextX;
                            this.mower.dy *= -1; // Flip Y
                            this.mower.fuel -= 0.1;
                            this.cut(this.mower.x, this.mower.y, true);
                        } else {
                            this.mower.dy *= -1;
                        }
                    }
                    // Case 3: Diagonal bounce
                    else {
                        if(nx < 0 || nx >= this.map.w) this.mower.dx *= -1;
                        if(ny < 0 || ny >= this.map.h) this.mower.dy *= -1;
                    }
                } 
                else {
                    this.mower.x = nx; this.mower.y = ny;
                    this.mower.fuel -= (0.05 * (this.mower.throttle/2));
                    this.cut(nx, ny, true);
                }
            }

            updateDrones() {
                this.drones.forEach(d => {
                    d.timer++;
                    if(d.timer >= 15) {
                        d.timer = 0;
                        if(Math.random()<0.3) d.dx = Math.random()>0.5?1:-1;
                        if(Math.random()<0.3) d.dy = Math.random()>0.5?1:-1;
                        let nx = d.x + d.dx; let ny = d.y + d.dy;
                        if(nx >= 0 && nx < this.map.w && ny >= 0 && ny < this.map.h) {
                            d.x = nx; d.y = ny;
                            this.cut(nx, ny, false);
                        } else { d.dx*=-1; d.dy*=-1; }
                    }
                });
            }

            cut(x, y, fillBag) {
                // BAG FULL LOGIC:
                // If fillBag is true (Player Mower) AND bag is full -> DO NOT CUT
                if (fillBag && this.mower.bag >= this.mower.maxBag) return;

                if(this.grid[y][x] > 0) {
                    this.grid[y][x] = 0;
                    this.spawnParticle(x, y, '#4caf50');
                    if(fillBag) this.mower.bag++;
                    else this.money++;
           
